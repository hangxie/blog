{"id":1619,"date":"2014-01-27T17:55:10","date_gmt":"2014-01-28T00:55:10","guid":{"rendered":"http:\/\/xiehang.com\/blog\/?p=1619"},"modified":"2014-09-17T19:30:11","modified_gmt":"2014-09-18T02:30:11","slug":"virtualization-glusterfs-and-automation","status":"publish","type":"post","link":"https:\/\/xiehang.com\/blog\/2014\/01\/27\/virtualization-glusterfs-and-automation\/","title":{"rendered":"Virtualization, GlusterFS, and automation"},"content":{"rendered":"<p>Finally I got some time playing with GlusterFS and libvirt.<\/p>\n<p>I&#8217;m not going to step into GlusterFS setup as it&#8217;s really easy and straight forward, I did CentOS kickstart (non-attendance) installation as well since it may help me in future deployment. Note that I assume you have glusterd running the host node, other all localhost below should be replaced by the hostname that is running glusterd.<!--more--><\/p>\n<p>First, create the kickstart file somewhere accessible through HTTP, assuming it is http:\/\/192.168.0.1\/kickstart.txt:<br \/>\n[raw]<br \/>\ninstall<br \/>\ncdrom<br \/>\ntext<br \/>\nlang en_US.UTF-8<br \/>\nkeyboard us<br \/>\nnetwork &#8211;onboot yes &#8211;device eth0 &#8211;bootproto dhcp &#8211;noipv6<br \/>\ntimezone &#8211;utc America\/Los_Angeles<br \/>\nrootpw  &#8211;iscrypted SOMETHING-COPIED-FROM-\/ETC\/SHADDOW<br \/>\nselinux &#8211;disabled<br \/>\nauthconfig &#8211;enableshadow &#8211;passalgo=sha512<br \/>\nfirewall &#8211;service=ssh<br \/>\npoweroff<\/p>\n<p>zerombr yes<br \/>\nclearpart &#8211;linux &#8211;drives=vda<br \/>\npart \/boot &#8211;fstype ext4 &#8211;size 512<br \/>\npart swap &#8211;recommended<br \/>\npart \/ &#8211;fstype ext4 &#8211;size 4096 &#8211;grow<\/p>\n<p>bootloader &#8211;location=mbr &#8211;timeout=5 &#8211;append=&#8221;rhgb quiet console=ttyS0&#8243;<\/p>\n<p>%packages &#8211;nobase<br \/>\nsudo<br \/>\nypbind<br \/>\nnfs-utils<br \/>\nntp<br \/>\nbind-utils<br \/>\n%end<br \/>\n[\/raw]<\/p>\n<p>I&#8217;m not going to explain configuration options one by one as you can get more detailed explanation from <a href=\"http:\/\/www.centos.org\/docs\/5\/html\/Installation_Guide-en-US\/s1-kickstart2-options.html\">CentOS&#8217;s kickstart documentation site<\/a>.<\/p>\n<p>Then, create the image file (raw format) on GlusterFS volume, you can do it on fuse mounted place at this moment since there won&#8217;t be any significant amount data to be written:<br \/>\n[shell]<br \/>\nsudo truncate -s 100G \/mnt\/glusterfs\/VM\/test-vm\/disk.img<br \/>\n[\/shell]<\/p>\n<p>Or you prefer qemu-img way:<br \/>\n[shell]<br \/>\nsudo qemu-img create -f raw gluster:\/\/localhost:24007\/glusterfs_vol_name\/VM\/test-vm\/disk.img 100G<br \/>\n[\/shell]<\/p>\n<p>Either one will create a sparsed file size 100G.<\/p>\n<p>Now, if you&#8217;ve downloaded the installation ISO to somewhere, do this:<br \/>\n[shell]<br \/>\nsudo virt-install &#8211;name test-vm &#8211;ram 1024 &#8211;vcpus 2 &#8211;disk path=\/mnt\/glusterfs\/VM\/test-vm\/disk.img,size=100 &#8211;network bridge=br1 &#8211;os-variant rhel6 &#8211;accelerate &#8211;location \/path\/to\/CentOS-6.2-x86_64-bin-DVD1.iso &#8211;graphics none -x &#8220;ks=http:\/\/192.168.0.1\/kickstart.txt console=ttyS0&#8221;<br \/>\n[\/shell]<\/p>\n<p>or if you prefer do a network installation:<br \/>\n[shell]<br \/>\nsudo virt-install &#8211;name test-vm &#8211;ram 1024 &#8211;vcpus 2 &#8211;disk path=\/mnt\/glusterfs\/VM\/test-vm\/disk.img,size=100 &#8211;network bridge=br1 &#8211;os-variant rhel6 &#8211;accelerate &#8211;location http:\/\/mirror.stanford.edu\/yum\/pub\/centos\/6\/os\/x86_64\/ &#8211;graphics none -x &#8220;ks=http:\/\/192.168.0.1\/kickstart.txt console=ttyS0&#8221;<br \/>\n[\/shell]<\/p>\n<p>After the installation, the machine should be powered-off, if for whatever reason it does not, do a poweroff, then do:<br \/>\n<code><br \/>\nsudo virsh list --all<br \/>\n<\/code><\/p>\n<p>to make sure test-vm is not running, then edit the VM&#8217;s configuration by:<br \/>\n[shell]<br \/>\nsudo virsh edit test-vm<br \/>\n[\/shell]<\/p>\n<p>The only thing needs to be changed is the location of the disk image, it should be:<br \/>\n[xml]<br \/>\n    <disk type='file' device='disk'><br \/>\n      <driver name='qemu' type='raw' cache='none'\/><source file='\/mnt\/glusterfs\/VM\/test-vm\/disk.img'\/><target dev='vda' bus='virtio'\/><\/p>\n<address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'\/>\n    <\/disk><br \/>\n[\/xml]<\/p>\n<p>and need to be changed to:<\/p>\n<p>[xml]<br \/>\n    <disk type='network' device='disk'><br \/>\n      <driver name='qemu' type='raw' cache='none'\/><source protocol='gluster' name='glusterfs_vol_name\/VM\/test-vm\/disk.img'><host name='localhost' port='24007'\/><br \/>\n      <\/source><br \/>\n      <target dev='vda' bus='virtio'\/><\/p>\n<address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'\/>\n    <\/disk><br \/>\n[\/xml]<\/p>\n<p>Remember double check ownership of the disk.img file &#8211; it should be owned by qemu:qemu, otherwise you are going to run into disk IO problem (in VM).<\/p>\n<p>Now, start the VM:<br \/>\n[shell]<br \/>\nsudo virsh start &#8211;console test-vm<br \/>\n[\/shell]<\/p>\n<p>and everything should be there \ud83d\ude42 .<\/p>\n<p>If you have problem with the VM and want to start over, you can:<br \/>\n[shell]sudo virsh reset test-vm[\/shell]<br \/>\nto power-cycle the VM,<br \/>\n[shell]sudo virsh destroy test-vm[\/shell],<br \/>\nto power-off the VM<br \/>\n[shell]sudo virsh undefine test-vm[\/shell],<br \/>\nto remove the VM from libvirt&#8217;s repository.<\/p>\n<p>I did some performance test on disk, putting the disk image on GlusterFS makes disk I\/O slow for sure, but I think it is still acceptable:<br \/>\n[shell]<br \/>\nglusterfs-fuse   1048576000 bytes (1.0 GB) copied, 192.922 s, 5.4 MB\/s<br \/>\nglusterfs-api    1048576000 bytes (1.0 GB) copied, 33.0347 s, 31.7 MB\/s<br \/>\nlocal-filesystem 1048576000 bytes (1.0 GB) copied, 5.70798 s, 184 MB\/s<br \/>\n[\/shell]<\/p>\n<p>The test command was:<br \/>\n[shell]<br \/>\ndd if=\/dev\/zero of=\/tmp\/dd-test bs=1M count=1000<br \/>\n[\/shell]<\/p>\n","protected":false},"excerpt":{"rendered":"<p>Finally I got some time playing with GlusterFS and libvirt. I&#8217;m not going to step into GlusterFS setup as it&#8217;s really easy and straight forward, I did CentOS kickstart (non-attendance) installation as well since it may help me in future deployment. Note that I assume you have glusterd running the host node, other all localhost <a href='https:\/\/xiehang.com\/blog\/2014\/01\/27\/virtualization-glusterfs-and-automation\/' class='excerpt-more'>[&#8230;]<\/a><\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"closed","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[1],"tags":[456,355,439,437,471,469,470],"_links":{"self":[{"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/posts\/1619"}],"collection":[{"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/comments?post=1619"}],"version-history":[{"count":20,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/posts\/1619\/revisions"}],"predecessor-version":[{"id":1713,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/posts\/1619\/revisions\/1713"}],"wp:attachment":[{"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/media?parent=1619"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/categories?post=1619"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/tags?post=1619"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}