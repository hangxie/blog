{"id":1372,"date":"2012-07-31T15:40:54","date_gmt":"2012-07-31T22:40:54","guid":{"rendered":"http:\/\/xiehang.com\/blog\/?p=1372"},"modified":"2014-01-28T11:09:56","modified_gmt":"2014-01-28T18:09:56","slug":"notes-on-nagios-setup","status":"publish","type":"post","link":"https:\/\/xiehang.com\/blog\/2012\/07\/31\/notes-on-nagios-setup\/","title":{"rendered":"Notes on Nagios setup"},"content":{"rendered":"<p>Trying to setup Nagios to play with monitoring facilities, turned out there are way too many things are NOT running out of the box. I&#8217;m trying to write as much as I can remember, so that I don&#8217;t have to Google again next time I step into the setup task again. Sure, others may be befinited from this as well.<\/p>\n<p>A brief intro about the environment &#8211; I have my monitoring node in EC2 in east coast, another 3 servers to be monitored in EC2 west cost, all four are running Ubuntu 12.04, plus another physical box sitting in a IDC in Beijing, China, running Fedora 14 (the owner does not want to upgrade for some reason). Almost all servers are running classic applications for Web, such as Nginx, mysql, etc. Other than those public services I also need to monitor system status like disk space, memory utilization, ssh liveness, etc.<!--more--><\/p>\n<p>The installation was pretty straightforward, for anything mentioned here you can do apt-cache\/yum search to find out the exact package to be installed. Just to mention that Fedora tends to separate plugins into LOTS of individual packages, while Ubuntu just group them up to several jumbo packages. Good or bad, it&#8217;s all up to you.<\/p>\n<p>Something new to me (last time I touched Nagios was 6 years ago) is that nrpe, with its help I can avoid setting up too many ACL holes to make monitoring works. I do encourage you take a look into this unless you have all servers stay in a same colocation, plus a firewall in front of all these boxes facing outside world.<\/p>\n<p>Here are several things I spent a little bit more time than other features:<\/p>\n<ul>\n<li>dont_blame_nrpe=1 for nrpe, so nrpe can take parameter from monitoring node<\/li>\n<li>some commands defined for nrpe:\n<pre>command[check_disk]=\/usr\/lib\/nagios\/plugins\/check_disk -w $ARG1$ -c $ARG2$\r\ncommand[check_users]=\/usr\/lib\/nagios\/plugins\/check_users -w $ARG1$ -c $ARG2$\r\ncommand[check_load]=\/usr\/lib\/nagios\/plugins\/check_load -w $ARG1$ -c $ARG2$\r\ncommand[check_mysql]=\/usr\/lib\/nagios\/plugins\/check_mysql -u $ARG1$ -p $ARG2$\r\ncommand[check_ntp]=\/usr\/lib\/nagios\/plugins\/check_ntp -H localhost\r\ncommand[check_disk]=\/usr\/lib\/nagios\/plugins\/check_disk -w $ARG1$ -c $ARG2$\r\ncommand[check_procs]=\/usr\/lib\/nagios\/plugins\/check_procs -w $ARG1$ -c $ARG2$<\/pre>\n<\/li>\n<li>To get graphs, install nagiosgrapher on monitoring node, and change following settings in nagios.cfg\n<pre>process_performance_data=1\r\nservice_perfdata_command=ngraph-process-service-perfdata-pipe<\/pre>\n<\/li>\n<li>Don&#8217;t forget change contact definition, so far I&#8217;m using email address, will dig in to see if there is any good and free services to do alerting stuffs<\/li>\n<li>Here is a tricky part to use white spaces in check_command definition:\n<pre># check mysql service\r\ndefine service {\r\nhostgroup_name\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 mysql-servers\r\nservice_description\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 MySQL over NRPE\r\ncheck_command\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 check_nrpe!check_mysql!username\\ pasword\r\nuse\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 generic-service\r\nnotification_interval\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 0 ; set &gt; 0 if you want to be renotified\r\n}<\/pre>\n<p>Note that the white space needs to be escaped by backslash (\\). It took me quite sometime to figure this out &#8230;<\/li>\n<li>Sometime you may want to issue the check manually (through the Web), or delete service comments. You have to enable external command in nagios.cfg:<br \/>\ncheck_external_commands=1<br \/>\nAlso, due to Ubuntu&#8217;s <a href=\"http:\/\/bugs.debian.org\/cgi-bin\/bugreport.cgi?bug=571801\">packaging issue<\/a>, you need to issue two more commands to get permission problem fixed (with sudo, for sure):<\/p>\n<pre>dpkg-statoverride --update --add nagios www-data 2710 \/var\/lib\/nagios3\/rw\r\ndpkg-statoverride --update --add nagios nagios 751 \/var\/lib\/nagios3<\/pre>\n<\/li>\n<\/ul>\n","protected":false},"excerpt":{"rendered":"<p>Trying to setup Nagios to play with monitoring facilities, turned out there are way too many things are NOT running out of the box. I&#8217;m trying to write as much as I can remember, so that I don&#8217;t have to Google again next time I step into the setup task again. Sure, others may be <a href='https:\/\/xiehang.com\/blog\/2012\/07\/31\/notes-on-nagios-setup\/' class='excerpt-more'>[&#8230;]<\/a><\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"closed","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[1],"tags":[352,351],"_links":{"self":[{"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/posts\/1372"}],"collection":[{"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/comments?post=1372"}],"version-history":[{"count":2,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/posts\/1372\/revisions"}],"predecessor-version":[{"id":1657,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/posts\/1372\/revisions\/1657"}],"wp:attachment":[{"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/media?parent=1372"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/categories?post=1372"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/tags?post=1372"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}