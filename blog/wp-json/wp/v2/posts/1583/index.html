{"id":1583,"date":"2013-08-30T10:59:51","date_gmt":"2013-08-30T17:59:51","guid":{"rendered":"http:\/\/xiehang.com\/blog\/?p=1583"},"modified":"2014-01-28T11:04:44","modified_gmt":"2014-01-28T18:04:44","slug":"play-with-python-on-windows","status":"publish","type":"post","link":"https:\/\/xiehang.com\/blog\/2013\/08\/30\/play-with-python-on-windows\/","title":{"rendered":"Play with Python on Windows"},"content":{"rendered":"<p>As I mentioned &#8211; I&#8217;m migrating my sysadm tasks from Perl to Python, and Windows is just one of them.<\/p>\n<p>This is a real case, I like VirtualBox as a neat visualization container, and spending lot of time on using it, actually there are always 2~3 VMs running on my laptop while another 4~5 lying on HDD. However, I have different requirements for different types of VMs, like for Windows VM, I used to launch them in GUI mode so that I can use another Windows environment, but for Linux and other *nix machines I used to launch them in headless mode and use putty (another neat tool \ud83d\ude42 ) to access.<!--more--><\/p>\n<p>The problem is that VirtualBox&#8217;s console does not support starting VMs in headless mode, so I created some BAT files to do it, but this makes things complicated that I have to go to two places to do actually one thing.<\/p>\n<p>Now here comes Python, plus VirtualBox guys kindly released a Python SDK. It was for Python 2.x, but no wonder some smart guy <a title=\"vboxapi Python 3\" href=\"https:\/\/github.com\/jbuergel\/vboxapi-py3\" target=\"_blank\">convert it to work with Python 3<\/a>. I was thinking of using win32 binding, but later on found Tkinter is good enough for this purpose. Codes posted below, feel free to take it as long as you can mention my name and link back to this post (I hate GPL &#8230; you can guess I&#8217;m a fan of BSD).<\/p>\n<p>I&#8217;ll do some more enhancement if I have to, but so far it can show button status based on VM state, and start\/stop\/reset the VMs, that&#8217;s pretty all I want at this moment. \ud83d\ude1b<br \/>\n[python]<br \/>\nimport sys<br \/>\nimport tkinter<br \/>\nfrom tkinter import messagebox<br \/>\nimport vboxapi<br \/>\nimport time<\/p>\n<p>mgr = vboxapi.VirtualBoxManager(None, None)<\/p>\n<p>def list_vms():<br \/>\n    global mgr<br \/>\n    vm_list = []<br \/>\n    for vm in mgr.getArray(mgr.vbox, &#8216;machines&#8217;):<br \/>\n        vm_list.append(vm)<br \/>\n    vm_list = sorted(vm_list, key = lambda k: k.name)<br \/>\n    return vm_list<\/p>\n<p>def start_vm(vm_id):<br \/>\n    global mgr, root, button_list<br \/>\n    root.config(cursor=&#8217;clock&#8217;)<br \/>\n    session = mgr.mgr.getSessionObject(mgr.vbox)<br \/>\n    try:<br \/>\n        # start the VM<br \/>\n        machine = mgr.vbox.FindMachine(vm_id)<br \/>\n        if mgr.vbox.getGuestOSType(machine.OSTypeId).familyId == &#8216;Windows&#8217;:<br \/>\n            start_type = &#8216;gui&#8217;<br \/>\n        else:<br \/>\n            start_type = &#8216;headless&#8217;<br \/>\n        progress = machine.launchVMProcess(session, start_type, &#8221;)<br \/>\n        progress.waitForCompletion(-1)<\/p>\n<p>        # change UI<br \/>\n        button_list[vm_id][&#8216;start&#8217;].config(state=tkinter.DISABLED)<br \/>\n        button_list[vm_id][&#8216;stop&#8217;].config(state=tkinter.NORMAL)<br \/>\n    except Exception as e:<br \/>\n        messagebox.showerror(&#8216;Error Happened&#8217;, e)<br \/>\n    finally:<br \/>\n        if session.state == mgr.constants.SessionState_Locked:<br \/>\n            session.unlockMachine()<br \/>\n        root.config(cursor=&#8221;)<\/p>\n<p>def stop_vm(vm_id):<br \/>\n    global mgr, root<br \/>\n    root.config(cursor=&#8217;clock&#8217;)<br \/>\n    session = mgr.mgr.getSessionObject(mgr.vbox)<br \/>\n    try:<br \/>\n        # stop (savestate) the VM<br \/>\n        mgr.vbox.FindMachine(vm_id).lockMachine(session, mgr.constants.LockType_Shared)<br \/>\n        session.console.saveState()<\/p>\n<p>        # change UI<br \/>\n        button_list[vm_id][&#8216;start&#8217;].config(state=tkinter.NORMAL)<br \/>\n        button_list[vm_id][&#8216;stop&#8217;].config(state=tkinter.DISABLED)<br \/>\n    except Exception as e:<br \/>\n        messagebox.showerror(&#8216;Error Happened&#8217;, e)<br \/>\n    finally:<br \/>\n        if session.state == mgr.constants.SessionState_Locked:<br \/>\n            session.unlockMachine()<br \/>\n        root.config(cursor=&#8221;)<\/p>\n<p>def reset_vm(vm_id):<br \/>\n    global mgr, root<br \/>\n    if not messagebox.askyesno(&#8216;Reset VM&#8217;, &#8216;Are you sure?&#8217;, default=&#8217;no&#8217;):<br \/>\n        return<\/p>\n<p>    root.config(cursor=&#8217;clock&#8217;)<br \/>\n    session = mgr.mgr.getSessionObject(mgr.vbox)<br \/>\n    try:<br \/>\n        # stop (savestate) the VM<br \/>\n        mgr.vbox.FindMachine(vm_id).lockMachine(session, mgr.constants.LockType_Shared)<br \/>\n        session.console.reset()<\/p>\n<p>        # change UI<br \/>\n        button_list[vm_id][&#8216;start&#8217;].config(state=tkinter.DISABLED)<br \/>\n        button_list[vm_id][&#8216;stop&#8217;].config(state=tkinter.NORMAL)<br \/>\n    except Exception as e:<br \/>\n        messagebox.showerror(&#8216;Error Happened&#8217;, e)<br \/>\n    finally:<br \/>\n        if session.state == mgr.constants.SessionState_Locked:<br \/>\n            session.unlockMachine()<br \/>\n        root.config(cursor=&#8221;)<\/p>\n<p>def timer():<br \/>\n    pass<br \/>\n    global mgr, vm_list, button_list, timer_lbl, root<\/p>\n<p>    # update button status according to VM state<br \/>\n    for index in range(0, len(vm_list)):<br \/>\n        if vm_list[index].state == mgr.constants.MachineState_Running:<br \/>\n            # VM is running<br \/>\n            button_list[vm_list[index].id][&#8216;start&#8217;].config(state=tkinter.DISABLED)<br \/>\n            button_list[vm_list[index].id][&#8216;stop&#8217;].config(state=tkinter.NORMAL)<br \/>\n            button_list[vm_list[index].id][&#8216;reset&#8217;].config(state=tkinter.NORMAL)<br \/>\n        elif vm_list[index].state == mgr.constants.MachineState_Saved or vm_list[index].state == mgr.constants.MachineState_PoweredOff or vm_list[index].state == mgr.constants.MachineState_Aborted:<br \/>\n            # VM is not running<br \/>\n            button_list[vm_list[index].id][&#8216;start&#8217;].config(state=tkinter.NORMAL)<br \/>\n            button_list[vm_list[index].id][&#8216;stop&#8217;].config(state=tkinter.DISABLED)<br \/>\n            button_list[vm_list[index].id][&#8216;reset&#8217;].config(state=tkinter.DISABLED)<br \/>\n        else:<br \/>\n            # VM is in interim state<br \/>\n            button_list[vm_list[index].id][&#8216;start&#8217;].config(state=tkinter.DISABLED)<br \/>\n            button_list[vm_list[index].id][&#8216;stop&#8217;].config(state=tkinter.DISABLED)<br \/>\n            button_list[vm_list[index].id][&#8216;reset&#8217;].config(state=tkinter.DISABLED)<\/p>\n<p>    # update clock<br \/>\n    timer_lbl.configure(text=time.strftime(&#8220;%Y-%m-%d %H:%M:%S&#8221;))<br \/>\n    root.after(1000, timer)<\/p>\n<p>vm_list = list_vms()<br \/>\nbutton_list = {}<br \/>\nroot = tkinter.Tk()<br \/>\ntimer_lbl = tkinter.Label(root, text=&#8221;, justify=tkinter.RIGHT)<br \/>\ntimer_lbl.grid(row=0, columnspan=4, sticky=tkinter.N, padx=10, pady=10)<br \/>\nfor index in range(0, len(vm_list)):<br \/>\n    if vm_list[index].state == mgr.constants.MachineState_Running:<br \/>\n        start_btn_state = tkinter.DISABLED<br \/>\n        stop_btn_state = tkinter.NORMAL<br \/>\n    else:<br \/>\n        start_btn_state = tkinter.NORMAL<br \/>\n        stop_btn_state = tkinter.DISABLED<\/p>\n<p>    # VM label<br \/>\n    lbl = tkinter.Label(root, text=vm_list[index].name)<br \/>\n    lbl.grid(row=index+1, sticky=tkinter.W, padx=5, pady=5)<\/p>\n<p>    # start button<br \/>\n    start_btn = tkinter.Button(root, text=&#8217;Start&#8217;, state=start_btn_state)<br \/>\n    start_btn[&#8216;command&#8217;] = lambda vm_id = vm_list[index].id: start_vm(vm_id)<br \/>\n    start_btn.grid(row=index+1, column=1, padx=5, pady=5)<\/p>\n<p>    # stop (save state) button<br \/>\n    stop_btn = tkinter.Button(root, text=&#8217;Stop&#8217;, state=stop_btn_state)<br \/>\n    stop_btn[&#8216;command&#8217;] = lambda vm_id = vm_list[index].id: stop_vm(vm_id)<br \/>\n    stop_btn.grid(row=index+1, column=2, padx=5, pady=5)<\/p>\n<p>    # reset (power recycle) button<br \/>\n    reset_btn = tkinter.Button(root, text=&#8217;Reset&#8217;, state=stop_btn_state)<br \/>\n    reset_btn[&#8216;command&#8217;] = lambda vm_id = vm_list[index].id: reset_vm(vm_id)<br \/>\n    reset_btn.grid(row=index+1, column=3, padx=5, pady=5)<\/p>\n<p>    button_list[vm_list[index].id] = {&#8216;start&#8217;: start_btn, &#8216;stop&#8217;: stop_btn, &#8216;reset&#8217;: reset_btn}<\/p>\n<p>timer()<br \/>\nroot.bind(&#8216;<Escape>&#8216;, lambda event: root.quit())<br \/>\nroot.mainloop()<br \/>\n[\/python]<\/p>\n","protected":false},"excerpt":{"rendered":"<p>As I mentioned &#8211; I&#8217;m migrating my sysadm tasks from Perl to Python, and Windows is just one of them. This is a real case, I like VirtualBox as a neat visualization container, and spending lot of time on using it, actually there are always 2~3 VMs running on my laptop while another 4~5 lying <a href='https:\/\/xiehang.com\/blog\/2013\/08\/30\/play-with-python-on-windows\/' class='excerpt-more'>[&#8230;]<\/a><\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"closed","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[1],"tags":[456,27,454,455,38],"_links":{"self":[{"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/posts\/1583"}],"collection":[{"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/comments?post=1583"}],"version-history":[{"count":9,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/posts\/1583\/revisions"}],"predecessor-version":[{"id":1645,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/posts\/1583\/revisions\/1645"}],"wp:attachment":[{"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/media?parent=1583"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/categories?post=1583"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/xiehang.com\/blog\/wp-json\/wp\/v2\/tags?post=1583"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}